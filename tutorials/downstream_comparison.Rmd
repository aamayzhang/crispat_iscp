---
title: "Effects of guide assignment for downstream analyses"
output: BiocStyle::html_document
date: "04/04/2024"
author: "Jana Braunger"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
BiocStyle::html_document 

data_dir = '/Users/janabraunger/Documents/Projects/scCRISPR/data/'
figdir = '/Users/janabraunger/Documents/Projects/scCRISPR/figures/Schraivogel_TAP/'
if(!dir.exists(figdir)) dir.create(figdir)
knitr::opts_chunk$set(dev = c("png", "pdf"), fig.path = figdir)
```

# Required libraries and data
## Load needed libraries
```{r load_libraries, message = FALSE, warning = FALSE}
library(tidyverse)
library(GGally)
library(UpSetR)
library(pheatmap)
```

## Load guide calling results
```{r}
# data frame containing the cells with single assignments per method
guide_assignment <- read_csv(paste0(data_dir, 'guide_calling/Schraivogel_TAP/', 
                                    'single_assignments_all_methods.csv'), show_col_types = FALSE) 
head(guide_assignment)

n_assigned_cells <- guide_assignment %>% 
  group_by(method) %>%
  summarize(n_cells = n()) 
head(n_assigned_cells)
```

```{r}
# save the colors to use in python
colors <- c('UMI_t7' = "#E6AB02", 'Maximum' = "#9ace25", 'ratio_50%' = "#00d360", 
            '2-Beta' = "#20ba94", '3-Beta' = "#009500", 'Cellranger' = "#06cdff",
            'Replogle' = "#06A4FF", 'SCEPTRE' = "#F8766D", 'Negative Binomial' = "#FF66A8", 
            'Binomial' = "#FB61D7", 'top_35%_cells' = "#DF70F8")
write_csv(data.frame(colors) %>% rownames_to_column(var = 'method'), 
          paste0(data_dir, 'sceptre_pipeline/schraivogel_tap_gRNA/colors.csv'))
```


## Load power check results for various guide calling approaches
```{r}
get_power_check_results <- function(data, name, method_names){
  method_name = method_names[method_names$dir_name == name, 'method']
  df = readRDS(paste0(data_dir, 'sceptre_pipeline/', data, '/', name, 
                                '/results_run_power_check.rds')) %>%
    filter(pass_qc == TRUE) %>%
    mutate(method = method_name)
  df <- df %>% mutate(p_adj = p.adjust(df$p_value, method="BH"))
  return(df)
}
```

```{r}
# define all methods
dir_names = c("2-BetaMM", "3-BetaMM", "gauss", "replogle", 
              "SCEPTRE", "maximum", "binomial", "negative_binomial",
              "quantiles/q0.35", "UMI_t/t8", "ratios/t0.8")
method_names <- data.frame('method' = c("2-Beta", "3-Beta", "Cellranger", "Replogle", 
                                        "SCEPTRE", "Maximum", "Binomial", "Negative Binomial",
                                        "top_35%_cells", "UMI_t7", "ratio_50%"), 
                           'dir_name' = dir_names)
data = 'schraivogel_tap_gRNA'

power_check <- lapply(dir_names, function(name) {get_power_check_results(data, name, method_names)}) %>% 
  bind_rows()%>%
  mutate(method = factor(method, levels = names(colors), ordered = TRUE))
head(power_check)
```


## Load calibration results for various guide calling approaches
```{r}
get_calibration_results <- function(data, name, method_names){
  method_name = method_names[method_names$dir_name == name, 'method']
  df = readRDS(paste0(data_dir, 'sceptre_pipeline/', data, '/', name, 
                           '/results_run_calibration_check.rds')) %>%
    filter(pass_qc == TRUE) %>%
    mutate(method = method_name)
  df <- df %>% mutate(p_adj = p.adjust(df$p_value, method="BH"))
  return(df)
}
```

```{r}
calibration <- lapply(dir_names, function(name) {get_calibration_results(data, name, method_names)}) %>% 
  bind_rows() %>%
  group_by(method) %>%
  mutate(total_tests = n()) %>%
  filter(significant == TRUE) %>%
  group_by(method, total_tests) %>%
  summarize(false_discoveries = n()) %>%
  mutate(fp_rate = false_discoveries/total_tests * 100) %>%
  mutate(method = factor(method, levels = names(colors), ordered = TRUE))
```


## Load discovery analysis results for various guide calling approaches
```{r}
get_discovery_analysis_results <- function(data, name, method_names){
  method_name = method_names[method_names$dir_name == name, 'method']
  df <- readRDS(paste0(data_dir, 'sceptre_pipeline/', data, '/', name, 
                           '/results_run_discovery_analysis.rds')) %>%
    filter(pass_qc == TRUE, significant == TRUE) %>%
    mutate(method = method_name)
}
```

```{r}
discovery_analysis <- lapply(dir_names, function(name) {get_discovery_analysis_results(data, name, method_names)}) %>% 
  bind_rows() %>%
  mutate(method = factor(method, levels = names(colors), ordered = TRUE))
head(discovery_analysis)
```


# Analysis of true positives (power check on target genes)
```{r sig_downreg_targets, fig.height=4, fig.width = 6}
# Number of significantly downregulated target genes
signif_targets <- power_check %>% filter(p_adj < 0.05) %>% 
  group_by(method) %>% 
  summarize(signif_targets = n()) %>%
  left_join(n_assigned_cells)


ggplot(signif_targets, aes(x = n_cells, y = signif_targets, group = method)) +
  geom_point(aes(color = method), size = 2) + 
  theme_bw() + 
  labs(x = 'Number of assigned cells', y = 'Number of significantly\ndownregulated target genes')  +
  scale_color_manual(name = 'Guide assignment', values = colors, 
                     breaks = names(colors))
```


```{r pairwise_log2fc, fig.height=10, fig.width=10}
# log2 fold changes of the target genes
lfc <- power_check %>% 
  subset(select = c(grna_id, log_2_fold_change, method)) %>% 
  spread(key = method, value = log_2_fold_change) %>%
  column_to_rownames(var = "grna_id")
dim(lfc[complete.cases(lfc), ])

lowerFn <- function(data, mapping) {
  p <- ggplot(data = data, mapping = mapping) +
    geom_point(size = 0.5) +
    geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed")
  p
}

ggpairs(lfc,
  diag = list(continuous = "density"),
  upper = list(continuous = "cor"),
  lower = list(continuous = wrap(lowerFn)),
  axisLabels = "show") +
  theme_bw()
```


```{r difference_heatmap_targets, fig.width=6, fig.height=5}
# calculate pairwise differences
calculate_diff <- function(lfc, method1, method2){
  diff <- (lfc[[method1]] - lfc[[method2]]) / sqrt(2)
  return(median(diff, na.rm = TRUE))
}

# create data frame with pairwise methods
pairs = expand.grid(colnames(lfc), colnames(lfc))
pairs$diff <- apply(pairs, 1, function(row) calculate_diff(lfc, row[1], row[2]))
diff_matrix <- pairs %>% 
  spread(key = Var2, value = diff) %>% 
  column_to_rownames(var = "Var1")

# plot heatmap
color_breaks <- seq(-0.8, 0.8, length.out = 100)
pheatmap(diff_matrix, display_numbers = T, 
         cluster_rows = F, cluster_cols = F, scale = "none",
         color = rev(colorRampPalette((RColorBrewer::brewer.pal(n = 7, name ="RdBu")))(100)),
         breaks = color_breaks,
         legend_title = "Median difference of log2 fold changes", 
         gaps_row = c(1, 5, 7), gaps_col = c(1,5,7))
```


# Discovery analysis 

```{r total_discoveries, fig.width=6, fig.height=4}
# scatter plot with number of total discoveries vs number of assigned cells
discoveries <- discovery_analysis %>% 
  group_by(method) %>% 
  summarize(total_discoveries = n()) %>% 
  left_join(n_assigned_cells)

ggplot(discoveries, aes(x = n_cells, y = total_discoveries, group = method)) +
  geom_point(aes(color = method), size = 2) +
  theme_bw() + 
  labs(color = 'Guide calling method', x = 'Number of assigned cells', y = 'Number of total discoveries') +
  scale_color_manual(name = 'Guide assignment', values = colors, 
                     breaks = names(colors))
```

```{r false_positives, fig.width=5, fig.height=4}
ggplot(calibration, aes(y = reorder(method, -false_discoveries), x = false_discoveries)) +
  geom_bar(stat = 'identity', fill = '#3776ab') + 
  theme_bw() + 
  labs(y = '', x = 'Number of false discoveries')
```

# Data set summary 
```{r summary_heatmap, fig.width=3, fig.height=4}
results <- data.frame(lfc = rowSums(diff_matrix)) %>% 
  rownames_to_column(var = 'method') %>%
  left_join(signif_targets %>% select(method, signif_targets)) %>%
  left_join(discoveries %>% select(method, total_discoveries)) %>%
  column_to_rownames(var = "method")
results <- as.data.frame(scale(results))

seq_breaks <- c(seq(min(results), 0, (0-min(results))/100 * 2), seq(0, max(results), (max(results)-0)/100 * 2)[-1])
pheatmap(results, labels_col = c("log2 fold change", "Significant targets",
                                 "Total discoveries"),
         cluster_rows=FALSE, cluster_cols = FALSE, breaks = seq_breaks, gaps_row = c(1, 5, 7),
         color = rev(colorRampPalette((RColorBrewer::brewer.pal(n = 7, name ="RdBu")))(100)))
```


# Session info
```{r}
sessionInfo()
```

